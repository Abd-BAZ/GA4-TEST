<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GA-4 Live Statistics</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FP2VEQZF5N"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FP2VEQZF5N');
    </script>
</head>
<body>
    <!-- Navigation Bar -->
    <div class="navbar">
        <a href="{{ url_for('index') }}">Home</a>
        <a href="{{ url_for('about') }}">About</a>
        <a href="{{ url_for('faq') }}">FAQ</a>
        <a href="{{ url_for('live_stats') }}" class="active">Live Stats</a>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard" class="container">
        <h1>GA-4 Dashboard</h1>
        <p>Click on a section below to view summarized statistics.</p>

        <div class="dashboard-boxes">
            <div class="box" onclick="loadSummary('home')">Home Stats</div>
            <div class="box" onclick="loadSummary('about')">About Stats</div>
            <div class="box" onclick="loadSummary('faq')">FAQ Stats</div>
        </div>
    </div>

    <!-- Summary Section (Hidden by Default) -->
    <div id="summary-section" class="container" style="display: none;">
        <button class="back-button" onclick="backToDashboard()">‚Üê Back to Dashboard</button>
        <h1 id="summary-title"></h1>
        <p>Below are the summarized user statistics for the selected section.</p>

        <!-- Metric Cards -->
        <div class="metric-cards">
            <div class="card">
                <h3>Active Users</h3>
                <p id="active-users-value">0</p>
                <span id="active-users-trend" class="trend"></span>
            </div>
            <div class="card">
                <h3>Page Views</h3>
                <p id="page-views-value">0</p>
                <span id="page-views-trend" class="trend"></span>
            </div>
            <div class="card">
                <h3>Event Count</h3>
                <p id="event-count-value">0</p>
                <span id="event-count-trend" class="trend"></span>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="chart-container">
            <canvas id="summary-chart"></canvas>
        </div>

        <!-- Tabs for Daily, Monthly, Yearly -->
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('daily')">Daily</button>
            <button class="tab-button" onclick="showTab('monthly')">Monthly</button>
            <button class="tab-button" onclick="showTab('yearly')">Yearly</button>
        </div>

        <!-- Summary Tables -->
        <div id="daily-table" class="summary-table">
            <h2>Daily Summary</h2>
            <table>
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be dynamically injected here -->
                </tbody>
            </table>
        </div>

        <div id="monthly-table" class="summary-table" style="display: none;">
            <h2>Monthly Summary</h2>
            <table>
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be dynamically injected here -->
                </tbody>
            </table>
        </div>

        <div id="yearly-table" class="summary-table" style="display: none;">
            <h2>Yearly Summary</h2>
            <table>
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be dynamically injected here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" style="display: none; text-align: center; margin-top: 20px;">
        <p>Loading...</p>
        <div class="spinner"></div>
    </div>

    <script>
        let currentSection = "";
        let currentSummaryData = {};
        let summaryChart;

        // Load summarized data for the selected section
        async function loadSummary(section) {
            currentSection = section;

            // Show loading indicator
            document.getElementById("loading").style.display = "block";

            // Update the summary title
            const summaryTitle = document.getElementById("summary-title");
            summaryTitle.textContent = `${section.charAt(0).toUpperCase() + section.slice(1)} Stats`;

            try {
                // Fetch the summarized data from the backend
                const response = await fetch(`/ga4-summary-${section}`);
                if (!response.ok) throw new Error("Failed to fetch GA-4 summary data.");
                const data = await response.json();
                currentSummaryData = data;

                // Update metric cards
                updateMetricCard("active-users", data.daily.activeUsers, data.monthly.activeUsers);
                updateMetricCard("page-views", data.daily.pageViews, data.monthly.pageViews);
                updateMetricCard("event-count", data.daily.eventCount, data.monthly.eventCount);

                // Render the chart
                renderChart(data.daily);

                // Populate the summary tables
                populateSummaryTable("daily", data.daily);
                populateSummaryTable("monthly", data.monthly);
                populateSummaryTable("yearly", data.yearly);

                // Show the summary section and hide the dashboard
                document.getElementById("dashboard").style.display = "none";
                document.getElementById("summary-section").style.display = "block";
                showTab("daily"); // Show the daily tab by default
            } catch (error) {
                console.error("Error fetching GA-4 summary data:", error);

                // Show an error message in the summary tables
                const tables = document.querySelectorAll(".summary-table tbody");
                tables.forEach(table => {
                    table.innerHTML = `<tr><td colspan="2" style="color: red; text-align: center;">Error loading data. Please try again later.</td></tr>`;
                });
            } finally {
                // Hide loading indicator
                document.getElementById("loading").style.display = "none";
            }
        }

        // Update a metric card with value and trend
        function updateMetricCard(metric, currentValue, previousValue) {
            const valueElement = document.getElementById(`${metric}-value`);
            const trendElement = document.getElementById(`${metric}-trend`);

            valueElement.textContent = currentValue;

            if (previousValue !== 0) {
                const trend = ((currentValue - previousValue) / previousValue) * 100;
                trendElement.textContent = `${trend.toFixed(1)}%`;
                trendElement.className = `trend ${trend >= 0 ? 'up' : 'down'}`;
            } else {
                trendElement.textContent = "N/A";
                trendElement.className = "trend";
            }
        }

        // Render the chart
        function renderChart(data) {
            const ctx = document.getElementById('summary-chart').getContext('2d');
            if (summaryChart) summaryChart.destroy(); // Destroy existing chart

            summaryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.dates || [],
                    datasets: [
                        {
                            label: 'Active Users',
                            data: data.activeUsers || [],
                            borderColor: '#5a67d8',
                            fill: false,
                        },
                        {
                            label: 'Page Views',
                            data: data.pageViews || [],
                            borderColor: '#4caf50',
                            fill: false,
                        },
                        {
                            label: 'Event Count',
                            data: data.eventCount || [],
                            borderColor: '#ff5722',
                            fill: false,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const date = data.dates[index];
                            alert(`You clicked on data for ${date}`);
                        }
                    },
                },
            });
        }

        // Populate a summary table with data
        function populateSummaryTable(tab, data) {
            const tableBody = document.getElementById(`${tab}-table`).querySelector("tbody");
            if (data.activeUsers === 0 && data.pageViews === 0 && data.eventCount === 0) {
                tableBody.innerHTML = `<tr><td colspan="2" style="text-align: center;">No data available.</td></tr>`;
            } else {
                tableBody.innerHTML = `
                    <tr>
                        <td>Active Users</td>
                        <td><a href="javascript:void(0);" onclick="loadDetails('activeUsers')">${data.activeUsers}</a></td>
                    </tr>
                    <tr>
                        <td>Page Views</td>
                        <td><a href="javascript:void(0);" onclick="loadDetails('pageViews')">${data.pageViews}</a></td>
                    </tr>
                    <tr>
                        <td>Event Count</td>
                        <td><a href="javascript:void(0);" onclick="loadDetails('eventCount')">${data.eventCount}</a></td>
                    </tr>
                `;
            }
        }

        // Show the selected tab and hide others
        function showTab(tab) {
            const tabs = ["daily", "monthly", "yearly"];
            tabs.forEach(t => {
                const table = document.getElementById(`${t}-table`);
                const button = document.querySelector(`.tab-button[onclick="showTab('${t}')"]`);
                if (t === tab) {
                    table.style.display = "block";
                    button.classList.add("active");
                } else {
                    table.style.display = "none";
                    button.classList.remove("active");
                }
            });
        }

        // Go back to the dashboard
        function backToDashboard() {
            document.getElementById("dashboard").style.display = "block";
            document.getElementById("summary-section").style.display = "none";
        }
    </script>
</body>
</html>