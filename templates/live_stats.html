<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GA-4 Live Statistics</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FP2VEQZF5N"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FP2VEQZF5N');
    </script>
</head>
<body>
    <!-- Navigation Bar -->
    <div class="navbar">
        <a href="{{ url_for('index') }}">Home</a>
        <a href="{{ url_for('about') }}">About</a>
        <a href="{{ url_for('faq') }}">FAQ</a>
        <a href="{{ url_for('live_stats') }}" class="active">Live Stats</a>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard" class="container">
        <h1>GA-4 Dashboard</h1>
        <p>Click on a section below to view summarized statistics.</p>

        <div class="dashboard-boxes">
            <div class="box" onclick="loadSummary('home')">Home Stats</div>
            <div class="box" onclick="loadSummary('about')">About Stats</div>
            <div class="box" onclick="loadSummary('faq')">FAQ Stats</div>
        </div>
    </div>

    <!-- Summary Section (Hidden by Default) -->
    <div id="summary-section" class="container" style="display: none;">
        <button class="back-button" onclick="backToDashboard()">← Back to Dashboard</button>
        <h1 id="summary-title"></h1>
        <p>Below are the summarized user statistics for the selected section.</p>

        <!-- Tabs for Daily, Monthly, Yearly -->
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('daily')">Daily</button>
            <button class="tab-button" onclick="showTab('monthly')">Monthly</button>
            <button class="tab-button" onclick="showTab('yearly')">Yearly</button>
        </div>

        <!-- Summary Tables -->
        <div id="daily-table" class="summary-table">
            <h2>Daily Summary</h2>
            <table>
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be dynamically injected here -->
                </tbody>
            </table>
        </div>

        <div id="monthly-table" class="summary-table" style="display: none;">
            <h2>Monthly Summary</h2>
            <table>
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be dynamically injected here -->
                </tbody>
            </table>
        </div>

        <div id="yearly-table" class="summary-table" style="display: none;">
            <h2>Yearly Summary</h2>
            <table>
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be dynamically injected here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Detailed Breakdown Section (Hidden by Default) -->
    <div id="details-section" class="container" style="display: none;">
        <button class="back-button" onclick="backToSummary()">← Back to Summary</button>
        <h1 id="details-title"></h1>
        <p>Below are the detailed user statistics for the selected metric.</p>

        <table id="details-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Page Path</th>
                    <th>Browser</th>
                    <th>Active Users</th>
                    <th>Page Views</th>
                    <th>Event Count</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be dynamically injected here -->
            </tbody>
        </table>
    </div>

    <script>
        let currentSection = "";
        let currentSummaryData = {};

        // Load summarized data for the selected section
        async function loadSummary(section) {
            currentSection = section;

            // Update the summary title
            const summaryTitle = document.getElementById("summary-title");
            summaryTitle.textContent = `${section.charAt(0).toUpperCase() + section.slice(1)} Stats`;

            // Fetch the summarized data from the backend
            try {
                const response = await fetch(`/ga4-summary-${section}`);
                if (!response.ok) throw new Error("Failed to fetch GA-4 summary data.");
                const data = await response.json();
                currentSummaryData = data;

                // Populate the summary tables
                populateSummaryTable("daily", data.daily);
                populateSummaryTable("monthly", data.monthly);
                populateSummaryTable("yearly", data.yearly);

                // Show the summary section and hide the dashboard
                document.getElementById("dashboard").style.display = "none";
                document.getElementById("summary-section").style.display = "block";
                showTab("daily"); // Show the daily tab by default
            } catch (error) {
                console.error("Error fetching GA-4 summary data:", error);

                // Show an error message in the summary tables
                const tables = document.querySelectorAll(".summary-table tbody");
                tables.forEach(table => {
                    table.innerHTML = `<tr><td colspan="2" style="color: red; text-align: center;">Error loading data. Please try again later.</td></tr>`;
                });
            }
        }

        // Populate a summary table with data
        function populateSummaryTable(tab, data) {
            const tableBody = document.getElementById(`${tab}-table`).querySelector("tbody");
            tableBody.innerHTML = `
                <tr>
                    <td>Active Users</td>
                    <td>${data.activeUsers}</td>
                </tr>
                <tr>
                    <td>Page Views</td>
                    <td>${data.pageViews}</td>
                </tr>
                <tr>
                    <td>Event Count</td>
                    <td>${data.eventCount}</td>
                </tr>
            `;
        }

        // Show the selected tab and hide others
        function showTab(tab) {
            const tabs = ["daily", "monthly", "yearly"];
            tabs.forEach(t => {
                const table = document.getElementById(`${t}-table`);
                const button = document.querySelector(`.tab-button[onclick="showTab('${t}')"]`);
                if (t === tab) {
                    table.style.display = "block";
                    button.classList.add("active");
                } else {
                    table.style.display = "none";
                    button.classList.remove("active");
                }
            });
        }

        // Go back to the dashboard
        function backToDashboard() {
            document.getElementById("dashboard").style.display = "block";
            document.getElementById("summary-section").style.display = "none";
        }

        // Go back to the summary section
        function backToSummary() {
            document.getElementById("summary-section").style.display = "block";
            document.getElementById("details-section").style.display = "none";
        }
    </script>
</body>
</html>